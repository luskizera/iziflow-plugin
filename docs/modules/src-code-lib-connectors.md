# Module: src-code/lib/connectors.ts

## Purpose and Scope

This module is responsible for creating and styling connector lines and their associated labels (for decision nodes) on the Figma canvas. It interprets `Connection` data from the flow definition, uses configuration from `layout.config.ts` and `styles.config.ts`, and applies theme colors from `theme.config.ts` to generate the visual connections between nodes.

The `/// <reference types="@figma/plugin-typings" />` directive indicates usage of Figma plugin API types.

## Namespace: `Connectors`

### `createConnectors(connections: Array<Connection>, nodeMap: { [id: string]: SceneNode }, nodeDataMap: { [id: string]: NodeData }, finalColors: Record<string, RGB>): Promise<void>`

The main exported function that orchestrates the creation of all connectors and their labels.

*   **Parameters**:
    *   `connections: Array<Connection>`: An array of connection objects defining links between nodes.
    *   `nodeMap: { [id: string]: SceneNode }`: A map where keys are node IDs and values are the corresponding Figma `SceneNode` objects already created on the canvas.
    *   `nodeDataMap: { [id: string]: NodeData }`: A map containing the parsed `NodeData` for each node ID.
    *   `finalColors: Record<string, RGB>`: A flat record of semantic token names to `RGB` color objects, typically generated by `theme.config.ts`.
*   **Process**:
    1.  **Font Loading**: Attempts to load the font specified in `StyleConfig.Labels.FONT` using `nodeCache.loadFont`. This is for rendering connector labels.
    2.  **Connection Counting**: Calculates `outgoingPrimaryCounts`, `nodeOutgoingPrimaryConnections`, and `incomingPrimaryCounts` to understand the flow structure, which influences connector styling and routing (e.g., for decision nodes, converging paths).
    3.  **Iterate Connections**: Loops through each `Connection` object.
        *   Retrieves the `fromNode`, `toNode` (Figma `SceneNode` objects) and `fromNodeData` (parsed data).
        *   Skips the connection if nodes or data are missing.
        *   Calls `determineConnectorConfig()` to get layout and style parameters for the current connection.
        *   Creates a Figma `ConnectorNode` using `figma.createConnector()`.
        *   Sets the connector's `name` for easier identification in the Figma layers panel.
        *   Sets `connector.connectorLineType`.
        *   Calls `attachConnectorEndpoints()` to link the connector to the start and end nodes using the determined magnets or positions.
        *   Calls `applyConnectorStyle()` to set stroke weight, dash pattern, end cap, and a fixed stroke color (currently black, theme colors for connectors seem to be planned but not used for the connector line itself in `applyConnectorStyle`).
        *   **Label Creation**: If the connection originates from a "DECISION" node and has a `conditionLabel` or `condition`, it asynchronously calls `createConnectorLabel()` to generate the label. These promises are collected.
    4.  **Await Labels**: Waits for all label creation promises to resolve using `Promise.all()`.
    5.  Logs completion or any errors encountered.

## Helper Functions

### `determineConnectorConfig(conn: Connection, fromNode: SceneNode, fromNodeData: NodeData, incomingPrimaryCountToTarget: number, nodeOutgoingPrimaryConnections: { [nodeId: string]: Array<Connection> }): DeterminedConnectorConfig`

Determines the specific layout and style configuration for an individual connector.

*   **Logic**:
    *   Identifies if the connection is `isSecondary`, originates from a `isDecisionOrigin`, or is a `isConvergingPrimary` path.
    *   Selects base style (stroke weight, dash pattern, end cap) from `StyleConfig.Connectors`.
    *   Sets `startConnection` (magnet or absolute position), `finalLineType`, `placeLabelNearStart` (boolean), `finalEndMagnet`, and `finalStartMagnetForLabel` based on the connection type and `LayoutConfig.Connectors` values.
    *   For decision nodes, it uses `LayoutConfig.Connectors.DECISION_PRIMARY_MAGNET_SEQUENCE` to pick a magnet based on the order of outgoing primary connections. It also calculates an absolute `position` for the connector start on the decision node.
    *   For straight line types, it may default to "CENTER" magnets.
*   **Returns**: A `DeterminedConnectorConfig` object containing all necessary parameters for creating and styling the connector. String types are used for `magnet` and `lineType` where Figma API types might have caused issues.

### `applyConnectorStyle(connector: ConnectorNode, styleBase: ConnectorStyleBaseConfig, isSecondary: boolean): void`

Applies non-color visual styles to a `ConnectorNode`.

*   Sets `connectorEndStrokeCap`, `dashPattern`, and `strokeWeight` based on `styleBase`.
*   **Important**: Currently sets `connector.strokes` to a fixed black color (`{r:0, g:0, b:0}`). It does not use the `finalColors` parameter for the connector line itself, though `finalColors` is passed to `createConnectorLabel`.

### `attachConnectorEndpoints(connector: ConnectorNode, fromNodeId: string, toNodeId: string, startConnection: { magnet?: string; position?: { x: number; y: number } }, endMagnet: string): void`

Attaches the start and end points of a `ConnectorNode` to the specified nodes.

*   If `startConnection.position` is provided, it uses that for the connector start (absolute position on `fromNodeId`).
*   Otherwise, it uses `startConnection.magnet`.
*   Uses `endMagnet` for the connector end.
*   Casts magnet strings (e.g., `"RIGHT"`) to `ConnectorMagnet` type when setting Figma API properties.

### `createConnectorLabel(labelText: string, fromNode: SceneNode, toNode: SceneNode, actualStartMagnetForLabel: string, placeNearStart: boolean, finalColors: Record<string, RGB>): Promise<void>`

Creates and positions a text label for a connector, primarily used for conditions on paths from "DECISION" nodes.

*   **Process**:
    1.  Creates a Figma `FrameNode` for the label with `layoutMode = "HORIZONTAL"` and auto-sizing.
    2.  Applies padding and corner radius from `StyleConfig.Labels` (using `DESC_CHIP_` constants).
    3.  Sets the label frame's fill color using `finalColors['chips_default_fill']`.
    4.  Creates a `TextNode` with the `labelText`.
    5.  Applies font and font size from `StyleConfig.Labels.FONT` and `StyleConfig.Labels.DESC_CHIP_FONT_SIZE`.
    6.  Sets the text node's fill color using `finalColors['chips_default_text']`.
    7.  Appends the text node to the label frame, and the label frame to the parent of the `fromNode`.
    8.  **Positioning**:
        *   Waits for Figma's auto-layout to calculate the label frame's size.
        *   Calculates the target (x, y) position for the label based on whether `placeNearStart` is true and the `actualStartMagnetForLabel`.
        *   If `placeNearStart`, it positions the label near the start of the connector, offset according to `LayoutConfig.Connectors.LABEL_OFFSET_NEAR_START`.
        *   Otherwise, it positions the label roughly in the middle of the connector path, with a vertical offset `LayoutConfig.Connectors.LABEL_OFFSET_MID_LINE_Y`.
        *   Estimates start point if exact connector start position isn't readily available.
    9.  Sets the label frame's `x` and `y` coordinates.
*   Handles errors during creation/positioning and attempts to remove the partially created label frame if an error occurs.

## Internal Interfaces

*   **`ConnectorStyleBaseConfig`**: Defines basic non-color style properties for connectors (`STROKE_WEIGHT`, `DASH_PATTERN`, `END_CAP`).
*   **`DeterminedConnectorConfig`**: A comprehensive configuration object returned by `determineConnectorConfig`, bundling all necessary style and layout info for a single connector.

## Key Dependencies

*   **`@shared/types/flow.types`**: For `NodeData` and `Connection` types.
*   **`../config/theme.config`**: For `RGB` type and consuming `finalColors`.
*   **`../config/layout.config` (`LayoutConfig`)**: For connector layout parameters (magnets, line types, label offsets).
*   **`../config/styles.config` (`StyleConfig`)**: For non-color styling of connectors and labels (stroke weight, dash patterns, font styles, padding, corner radius).
*   **`../utils/nodeCache`**: For loading fonts.
*   **Figma Plugin API**: Extensively used for creating `ConnectorNode`, `FrameNode`, `TextNode`, and setting their properties.

This module encapsulates the complex logic of translating abstract connection data into visually styled and positioned connectors and labels on the Figma canvas, adhering to the defined layout and style rules.
